<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" content="width=device-width" />
<title>SocialHub XO Game</title>
<script src="/socket.io/lib/socket.io.js"></script>
</head>
<body>
<div data-role="page">
<div data-role="header"><h3>SocialHub XO Game</h3></div>
<div data-role="content">
<div id="error_message" style="color:red"> </div>
<div id="notification" style="color:teal"></div>
<div id="game_options">
<h3 id="choose_competitor_header">Choose Competitor</h3>
<div id="choose_competitor">
 
</div>
<h3 style="text-align:center">Choose a piece</h3>
<table align="center">
<tr>                                                                                                           
<td><button  onclick="setPiece('X')" id="btnX" style="width:200px;height:50px;color:red">X </button></td>
<td><button  onclick="setPiece('O')" id="btnO" style="width:200px;height:50px;color:red">O </button></td>
</tr>
</table> 
</div>
<div id="game_board">
<table id="road" border="1" class="ui-corner-all"  align="center">
<tr ><td id="10" onclick="setMove(10)" style="width:200px;height:250px;"></td><td id="20" onclick="setMove(20)" style="width:200px;height:250px;"></td><td id="30" onclick="setMove(30)" style="width:200px;height:250px;"></td></tr>
<tr><td id="11" onclick="setMove(11)" style="width:200px;height:250px;"></td><td id="21" onclick="setMove(21)" style="width:200px;height:250px;"></td><td id="31" onclick="setMove(31)" style="width:200px;height:250px;"></td></tr>
<tr><td id="12" onclick="setMove(12)" style="width:200px;height:250px;"></td><td id="22" onclick="setMove(22)" style="width:200px;height:250px;"></td><td id="32" onclick="setMove(32)" style="width:200px;height:250px;"></td></tr>
</table>
<div id="chat_box">
	<h3>Chat</h3>
	<div id="chat_messages"></div>
    <br />
    <label for="chat_message">Message:</label>
   <textarea id="chat_message"></textarea>
   <br />
   <button id="send_message">Send</button>
   </div>
<div id="timer" align="center"> </div>
</div>
</div>
<div data-role="footer"></div>
</div>
<script type="text/javascript">
	var socket = io.connect('http://localhost:8000/game');
	var game_board = document.getElementById("game_board").innerHTML;
	var game_options = document.getElementById("game_options").innerHTML;
	var comp_name = "";
	var request_data;
	var challenge;
	var challenge_request;
	var onlineUsers;
	var move_number = 0;
	var move_data = Array();
	var end_game_message;
	var moveInfo; 
	var in_game = false;
	
		document.getElementById("game_board").innerHTML = "";
		socket.emit("turn_socialhub_on");
		socket.emit("join_game",localStorage['socialhub_username']);
		socket.emit("get_game_online_users");
	
	
	 
	 socket.on("game_online_users",function(data){
		     onlineUsers = JSON.parse(data);
		     message = "";
				 onlineUsers.forEach(function(onlineUser){
					if(onlineUser!=localStorage['socialhub_username']){
				        message += "[<a href='#' id='"+onlineUser+"'>"+onlineUser+"</a>]";
				  }
				 });
				 
		if(document.getElementById("choose_competitor") != null)	 
		    document.getElementById("choose_competitor").innerHTML = message;
		 	onlineUsers.forEach(function(onlineUser){
		 		if(document.getElementById(onlineUser)!=null)
				 document.getElementById(onlineUser).addEventListener("click",function(e){
				 	comp_name = "";
				 	comp_name = onlineUser;
				 	document.getElementById("choose_competitor_header").innerHTML = "Choosen Competitor";
				 	document.getElementById("choose_competitor").innerHTML = onlineUser;
				 	e.preventDefault();
			 });
		 });
	 });
	 
	 
	 socket.on("challenge_request",function(data){
		 data = JSON.parse(data);
		 if(in_game==false){
		 request_data = data;
		 // if this challenge is meant for you
		 if(localStorage['socialhub_username']==data.name){
			document.getElementById("notification").innerHTML = "";
			challenge_request = data.challenger+" would like to play against you. He/she will be using the following piece: "+data.piece; 
		 	challenge_request += "<br /><button id='accept_request'>Accept</button><button id='decline_request'>Not Now</button>"
		 	document.getElementById("game_options").innerHTML = challenge_request;
		 	
		 	document.getElementById("accept_request").addEventListener("click",function(e){
	    		socket.emit("accept_request",request_data);
	    		document.getElementById("game_options").innerHTML = "";
	    		document.getElementById("game_board").innerHTML = game_board;
	    		sessionStorage['piece'] = data.piece == "X" ? "O" : "X";
	    		sessionStorage['your_move'] = "false";
	    		document.getElementById("notification").innerHTML = data.challenger+"'s turn.";
	    		sessionStorage['against'] = data.challenger;
	    		e.preventDefault();
		     });
		 	
		 	document.getElementById("decline_request").addEventListener("click",function(e){
				socket.emit("decline_request",request_data);
				document.getElementById("game_options").innerHTML = game_options;
				socket.emit("get_game_online_users");
				e.preventDefault();
	    	 });
		 }
	 }else{
		 socket.emit("in_a_game",data.challenger);
	 }
		 	
	 });
	 
	 
	 socket.on("in_a_game",function(data){
		 if(data==localStorage['socialhub_username']){
			 document.getElementById("game_options").innerHTML = game_options;
			 document.getElementById("notification").innerHTML = "The user is currently in a game.";
		 }
		 
	 });
	 	
	socket.on("user_accepted",function(data){
		//data = JSON.parse(data);
		// if you're the challenger. This message is meant for you
		 if(localStorage['socialhub_username']==data.challenger){
				document.getElementById("game_options").innerHTML = "";
				document.getElementById("game_board").innerHTML = game_board;
				sessionStorage['piece'] = data.piece;
				sessionStorage['your_move'] = "true";
				sessionStorage['against'] = data.name;
				document.getElementById("notification").innerHTML = "Your turn.";
				in_game = true;
		 }
	});	
	
	socket.on("user_declined",function(data){
		//data = JSON.parse(data);
		// if you're the challenger. This message is meant for you
		 if(localStorage['socialhub_username']==data.challenger){
			 comp_name = "";
			 document.getElementById("game_options").innerHTML = data.name+" is scared of your challenge.<br />";
			 document.getElementById("game_options").innerHTML += game_options;
			 socket.emit("get_game_online_users");
		 }
	});
	
	
	socket.on("move_made",function(data){
		data = JSON.parse(data);
		if(data.move_to==localStorage['socialhub_username']){
			document.getElementById(data.move_coords).innerHTML = data.piece;
			sessionStorage['your_move']="true";
			document.getElementById("notification").innerHTML = "Your move";
		}
 		move_number++;
 		move_data[parseInt(data.move_coords)] = data.piece;
 		if(move_number>2){
 			checkWin();
 		}
	});
	
	
	socket.on("game_player_logged_out",function(name){
		if(name==sessionStorage['against']){
				document.getElementById("notification").innerHTML = name+" chickened out.";
				document.getElementById("game_options").innerHTML = "";
				setTimeout(function(){
					postEndGameState();
				},2000);
	  }
		
	});
	
	socket.on("game_ended",function(data){
	  // if the game that just ended is the one you are currently playing
	//if(data.status_to==sessionStorage['socialhub_username']){
	  if(data.status == 1)
		 	end_game_message = "You lose. Try again." 
			else if(data.status == 0)
		 		end_game_message = "Congratulations! You won.";
		 		    else
		 			  end_game_message = "It's a draw.";
	     document.getElementById("notification").innerHTML = end_game_message;
	     postEndGameState();
	     in_game = false;
		//}
		
	});
	
	 
	 var setPiece = function(piece){
		 if(comp_name!=""){
			  	challenge = {
					  "name" : comp_name,
					  "challenger" : localStorage['socialhub_username'],
					  "piece" : piece
			 	}
			 socket.emit("challenge",JSON.stringify(challenge));
			 document.getElementById("game_options").innerHTML = "Your challenge request to "+comp_name+" has been sent. Please wait for a response.";
		 }else{
			 document.getElementById("error_message").innerHTML = "Please choose a person you want to play against.";
			 setTimeout(function(){
				 document.getElementById("error_message").innerHTML = "";
			  },4000);
		 }
		 
	 }
	 
	 
	 var setMove = function(coords){
		 if(sessionStorage['your_move']=="true"){
			 if(document.getElementById(coords).innerHTML==""){
			 moveInfo = {
					 move_coords : coords,
					 piece : sessionStorage['piece'],
					 move_to : sessionStorage['against']
			 }
			socket.emit("make_move",JSON.stringify(moveInfo));
			document.getElementById(coords).innerHTML = sessionStorage['piece'];
			sessionStorage['your_move']="false";
			document.getElementById("notification").innerHTML = sessionStorage['against']+"'s turn";
			 }else{
				 document.getElementById("notification").innerHTML = "Move taken.";
				 setTimeout(function(){
					 document.getElementById("notification").innerHTML = "";
				 },4000);
			 }
		 }else{
			 document.getElementById("notification").innerHTML = sessionStorage['against']+"'s turn";
			 setTimeout(function(){
				 document.getElementById("notification").innerHTML = "";
			 },4000);
		 }
	 }
	 
	var play_coords = Array("X","O");
	var someone_won = false;
	var checkWin = function(){
		for(var i=0;i<play_coords.length;i++){
			if(move_data[10]==play_coords[i] && move_data[11]==play_coords[i] && move_data[12]==play_coords[i]){
			    play_coords[i] ==  sessionStorage['piece'] ? endGame(1) : endGame(0);
			      someone_won = true;
				
			}
				
				if(move_data[20]==play_coords[i] && move_data[21]==play_coords[i] && move_data[22]==play_coords[i]){
					play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
					    someone_won = true;
				}
					
					if(move_data[30]==play_coords[i] && move_data[31]==play_coords[i] && move_data[32]==play_coords[i]){
						play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
						someone_won = true;
					}
						
						if(move_data[10]==play_coords[i] && move_data[20]==play_coords[i] && move_data[30]==play_coords[i]){
							play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
							    someone_won = true;
						}
							
							if(move_data[11]==play_coords[i] && move_data[21]==play_coords[i] && move_data[31]==play_coords[i]){
								play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
								  someone_won = true;
							}
								
								if(move_data[12]==play_coords[i] && move_data[22]==play_coords[i] && move_data[32]==play_coords[i]){
									play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
									   someone_won = true;
								}
									
									if(move_data[10]==play_coords[i] && move_data[21]==play_coords[i] && move_data[32]==play_coords[i]){
										play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
										  someone_won = true;
									}
									     
											if(move_data[30]==play_coords[i] && move_data[21]==play_coords[i] && move_data[12]==play_coords[i]){
												play_coords[i] == sessionStorage['piece'] ? endGame(1) : endGame(0);
												someone_won = true;
										  }
									
		}
		
		if(someone_won != true && move_number==6){
			// it's a draw
			 document.getElementById("notification").innerHTML = "It's a draw.";
			 postEndGameState();
			gameEndStatus = {
					status :  2,
					status_to : sessionStorage["against"]
				}
		    socket.emit("end_game",JSON.stringify(gameEndStatus));
			move_number = 0;
		}
	} 
	
	var gameEndStatus;
	var endGame = function(tempStatus){
		 if(tempStatus == 1)
			end_game_message = "Congratulations! You won."
			 else if(tempStatus==0)
			    end_game_message = "You lose. Try again.";
		 
		 document.getElementById("notification").innerHTML = end_game_message;
		 postEndGameState();
		gameEndStatus = {
					status :  tempStatus,
					status_to : sessionStorage["against"]
				}
		socket.emit("end_game",JSON.stringify(gameEndStatus));
		in_game = false;
		move_number = 0;
	}
	
	var postEndGameState = function(){
		
		document.getElementById("notification").innerHTML += "<br /><button id='play_again'>Play again</button>";
		document.getElementById("game_board").innerHTML = "";
		sessionStorage['against'] = "";
	     if(document.getElementById("play_again")!=null)
	     	document.getElementById("play_again").addEventListener("click",function(){
	     	document.getElementById("notification").innerHTML = "";
		 	document.getElementById("game_options").innerHTML = game_options;
		 	socket.emit("get_game_online_users");
		
	     });
		
	}
</script>
</body>
</html>